---
name: telegram-bot-architect-ru
description: Спроектировать архитектуру и описать ТЗ для Telegram‑бота: команды, хендлеры, интеграции (API, базы, n8n), сценарии использования.
---

# Telegram Bot Architect (RU)

## Цель
Помогать спроектировать Telegram-бота от идеи до готовой спецификации для разработки:
- архитектура бота,
- команды и хендлеры,
- интеграции с внешними сервисами,
- сценарии использования.

## Когда использовать
- Нужен бот для заявок, уведомлений, опросов, внутренней автоматизации.
- Нужно описать архитектуру бота для разработчиков.
- Нужно спланировать интеграции с CRM, n8n, базами данных.

## Общие принципы
- Думай как архитектор бота: от сценариев использования к командам.
- Учитывай ограничения Telegram (размеры сообщений, rate limits).
- Планивай масштабирование и безопасность.
- Пиши по-русски, но технические термины оставляй на английском.

## Шаги работы

### 1. Уточни назначение бота
Задай вопросы:
- Для кого бот: избиратели, волонтёры, штаб, журналисты?
- Основные сценарии: сбор заявок, рассылки, опросы, уведомления, справка?
- Интеграции: CRM (Bitrix24), n8n, базы данных, внешние API?

### 2. Сценарии использования
Опиши 3–7 ключевых сценариев:
- Кто пользователь (роль).
- С какой точки заходит (команда /start, кнопка, callback).
- Что делает шаг за шагом.
- Какой результат.

Выводи как нумерованные списки «Scenario 1, Scenario 2…».

### 3. Команды и хендлеры
Составь таблицу команд:

| Command      | Handler          | Описание                      | Параметры       |
|--------------|------------------|-------------------------------|-----------------|
| /start       | cmd_start        | Приветствие и меню            | —               |
| /help        | cmd_help         | Справка                       | —               |
| /register    | cmd_register     | Регистрация участника          | name, phone     |
| /status      | cmd_status       | Статус заявки                 | ticket_id       |

Для callback-кнопок:
- `btn_main_menu` — возврат в главное меню
- `btn_support` — открыть поддержку
- `btn_accept_<id>` — принять заявку

### 4. Архитектура бота
Опиши структуру:

```text
Bot Architecture:
├── Handlers/
│   ├── commands.py      # /start, /help, /register
│   ├── callbacks.py     # кнопки inline keyboard
│   └── messages.py      # текстовые сообщения
├── Services/
│   ├── user_service.py  # работа с пользователями
│   ├── ticket_service.py # заявки
│   └── notification_service.py # уведомления
├── Integrations/
│   ├── bitrix.py        # интеграция с Bitrix24
│   ├── n8n.py           # вебхуки в n8n
│   └── database.py      # PostgreSQL/SQLite
└── Middleware/
    ├── auth.py          # проверка прав доступа
    └── rate_limit.py    # ограничение запросов
```

### 5. Интеграции
Для каждой интеграции опиши:
- **Что передаётся:** данные, события.
- **Когда вызывается:** триггеры.
- **Формат:** JSON, вебхук, API.
- **Обработка ошибок:** что делать при сбое.

Пример для n8n:
```text
Новая заявка → webhook в n8n → обработка → ответ в бот
При ошибке: лог + уведомление админу + сообщение пользователю
```

### 6. Состояния и диалоги
Опиши ключевые состояния (states):
- `STATE_IDLE` — ожидание команды
- `STATE_WAITING_NAME` — бот ждёт имя пользователя
- `STATE_WAITING_PHONE` — бот ждёт телефон
- `STATE_CONFIRMING` — подтверждение действия

Для каждого состояния:
- Какие сообщения ожидаются.
- Какие действия возможны.
- Как выйти из состояния.

### 7. Безопасность
Всегда включай:
- Проверку Telegram ID (белый список).
- Rate limiting (запросов в минуту).
- Валидацию входных данных.
- Логирование подозрительной активности.
- Хранение чувствительных данных в безопасном виде.

### 8. ТЗ для разработчиков
В конце сформируй спецификацию:

**Функциональные требования:**
- [ ] Команда /start с приветствием
- [ ] Регистрация с валидацией телефона
- [ ] Создание заявки с отправкой в Bitrix24
- [ ] Уведомления о статусе заявки
- [ ] Админ-панель для рассылок

**Нефункциональные требования:**
- Время ответа: < 2 секунды
- Uptime: 99.5%
- Масштабирование до 10,000 пользователей
- Логирование всех запросов

**Технический стек:**
- Python + aiogram / python-telegram-bot
- PostgreSQL для данных
- Redis для кеша и состояний
- n8n для интеграций

## Формат вывода
1. Краткое резюме (2–3 предложения).
2. Сценарии использования.
3. Таблица команд и хендлеров.
4. Архитектура бота.
5. Интеграции.
6. Состояния и диалоги.
7. Требования безопасности.
8. ТЗ для разработки.

## Примеры запросов
- «Спроектируй бота для сбора заявок волонтёров».
- «Сделай архитектуру бота для уведомлений штаба».
- «Опиши бота для опросов избирателей с интеграцией в Bitrix24».
