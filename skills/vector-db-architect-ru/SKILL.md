---
name: vector-db-architect-ru
description: Проектировать векторные базы данных: коллекции, embedding-модели, RAG‑пайплайны, поиск и релевантность для AI‑агентов.
---

# Vector DB Architect (RU)

## Цель
Помогать спроектировать векторную базу данных и RAG-пайплайн:
- определить структуру коллекций,
- выбрать embedding-модель,
- описать пайплайн поиска и генерации,
- настроить релевантность и фильтры.

## Когда использовать
- Нужна база знаний для AI-агента (RAG).
- Требуется семантический поиск по документам.
- Нужно спланировать архитектуру векторной БД.
- Требуется оптимизировать релевантность поиска.

## Общие принципы
- Векторная БД = семантический поиск по смыслу, не по ключевым словам.
- Embedding = числовое представление текста (вектор).
- RAG = Retrieval Augmented Generation (поиск + генерация).
- Качество зависит от: embedding-модели, размера чанков, метрики сходства.

## Шаги работы

### 1. Уточни задачу
Задай вопросы:
- Какие данные: документы, статьи, переписки, код?
- Сколько данных: тысячи, миллионы документов?
- Какой поиск: точный ответ, похожие документы, гибридный?
- Где использовать: AI-агент, веб-сайт, бот?

### 2. Выбор векторной БД
Рекомендации по выбору:

| БД           | Для кого                      | Масштаб      | Особенности              |
|--------------|-------------------------------|--------------|--------------------------|
| Qdrant       | Для всех, простой старт       | 10M+ векторов| Cloud + Self-hosted      |
| Pinecone    | Для prototyping, простой API  | 5M+ векторов | Только cloud             |
| Weaviate     | Для сложных фильтров          | 10M+ векторов| GraphQL API, гибридный   |
| Chroma      | Для локального использования  | 1M+ векторов | Простая, embedded       |
| Milvus       | Для Enterprise                | 100M+ векторов| Много функций           |

**Рекомендация:** начни с Qdrant (self-hosted) или Pinecone (cloud).

### 3. Embedding-модель
Выбор модели:

| Модель              | Размер | Языки       | Стоимость      | Когда использовать            |
|---------------------|--------|-------------|----------------|-------------------------------|
| OpenAI text-embedding-3-small | 1536  | Многоязычная  | $$             | Когда нужно качество          |
| OpenAI text-embedding-3-large | 3072  | Многоязычная  | $$$            | Для максимального качества    |
| sentence-transformers/* | 384-768 | В основном EN | $ (self-hosted)| Для бюджета, локально        |
| intfloat/multilingual-e5 | 768   | Многоязычная  | $ (self-hosted)| Для русского                 |
| BGE-multilingual    | 1024   | Многоязычная  | $$             | Лучшее для русского           |

**Рекомендация для русского:**
- BGE-multilingual (качество)
- intfloat/multilingual-e5 (бюджет)

### 4. Структура коллекции
Опиши схему:

```text
Collection: documents
Векторное поле: embedding (1536 dim, OpenAI)
Полнотекстовое поле: content
Метаданные:
  - id (string): уникальный идентификатор
  - title (string): заголовок документа
  - source (string): источник (wiki, notion, pdf)
  - category (string): категория (docs, news, faq)
  - created_at (datetime): дата создания
  - updated_at (datetime): дата обновления
  - tags (array[string]): теги
Индексы:
  - fulltext: content (для keyword search)
  - payload: category, source
```

### 5. Чанкование (Chunking)
Разбивка документов на части:

**Стратегии:**
- **Фиксированный размер:** 500-1000 токенов (простой)
- **Семантический:** по параграфам, секциям (лучше)
- **Иерархический:** summary + chunks (сложнее, качественнее)

**Пример конфигурации:**
```text
Chunk size: 500 tokens
Chunk overlap: 50 tokens
Min chunk size: 100 tokens
Max chunk size: 1000 tokens

Стратегия: semantic (по параграфам + заголовкам)
```

### 6. RAG-пайплайн
Опиши поток данных:

```text
1. User Query
   ↓
2. Embed Query (создать вектор из вопроса)
   ↓
3. Search (найти похожие чанки)
   - Top-k: 5-10 результатов
   - Score threshold: > 0.7
   - Filters: category = "docs"
   ↓
4. Rerank (переупорядочить результаты)
   - Cross-encoder для точности
   - Top-3 результата
   ↓
5. Build Context (собрать контекст)
   - Format: "Document: {title}\n{chunk}\n\n"
   ↓
6. Generate (генерация ответа)
   - Prompt: "Based on context:\n{context}\n\nAnswer: {query}"
   - Model: Claude 3.5 / GPT-4
   ↓
7. Response (ответ с источниками)
   - Answer: текст ответа
   - Sources: ссылки на документы
```

### 7. Настройка релевантности
Параметры поиска:

**Метрика сходства:**
- Cosine (косинусное сходство) — по умолчанию
- Euclidean (евклидово расстояние)
- Dot product — для нормализованных векторов

**Параметры:**
```text
Top-k: 10 (количество результатов)
Score threshold: 0.7 (минимальная схожесть)
Rerank: cross-encoder (переупорядочить)
Hybrid: 0.7 vector + 0.3 keyword (гибридный поиск)
```

**Фильтры:**
- По категории: `category = "faq"`
- По дате: `created_at > 2024-01-01`
- По тегам: `tags includes "important"`

### 8. Производительность
Оптимизация:

**Индексирование:**
- HNSW индекс (быстрый поиск)
- EF: 100-200 (точность vs скорость)
- M: 16-32 (connections per node)

**Кеширование:**
- Результаты поиска: 5 минут
- Embedding запросов: 1 час
- Частые запросы: постоянно

**Масштабирование:**
- Репликация для чтения
- Шардирование по категориям
- Batch обработка для индексации

### 9. Спецификация для реализации
ТЗ для разработки:

**Функциональные требования:**
- [ ] Collection: documents с embedding
- [ ] API: search(query, filters, top_k)
- [ ] API: insert(documents)
- [ ] API: delete(ids)
- [ ] RAG-пайплайн: query → search → generate
- [ ] Гибридный поиск: vector + keyword

**Нефункциональные требования:**
- Время поиска: < 100ms (p95)
- Индексация: 1000 docs/sec
- Доступность: 99.5%
- Хранение: 1M+ векторов

**Технологии:**
- Qdrant (self-hosted или cloud)
- OpenAI embeddings или BGE-multilingual
- Claude/GPT для генерации
- Python + FastAPI (API сервер)

## Формат вывода
1. Резюме задачи.
2. Выбор векторной БД и embedding-модели.
3. Структура коллекции.
4. Стратегия чанкования.
5. RAG-пайплайн (схема).
6. Параметры поиска и фильтры.
7. Производительность и масштабирование.
8. ТЗ для реализации.

## Примеры запросов
- «Спроектируй векторную БД для базы знаний штаба».
- «Сделай RAG-пайплайн для AI-агента».
- «Как оптимизировать релевантность поиска?».
- «Опиши структуру коллекции для документов».
